<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Secret Toys - Firebase Board</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f5f6f8; margin: 0; padding: 0; }
        .header { background: #2c3e50; color: white; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; }
        .container { width: 950px; margin: 40px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .board-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .search-box { margin-bottom: 20px; display: flex; gap: 10px; }
        .search-box input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex-grow: 1; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .write-btn { background: #3498db; color: white; }
        .save-btn { background: #2ecc71; color: white; }
        .delete-btn { background: #e74c3c; color: white; }
        .back-btn { background: #95a5a6; color: white; }
        .edit-btn { background: #f1c40f; color: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #ddd; }
        th { background: #f0f2f5; }
        
        /* 행 디자인 (이제 클릭으로 체크되지 않으므로 cursor: default 설정) */
        .post-row { transition: background-color 0.2s; cursor: default; }
        .post-row:hover { background-color: #fafafa; }
        .post-row.selected { background-color: #e8f4fd !important; }
        
        .category-badge { display: inline-block; padding: 3px 8px; background: #eee; border-radius: 4px; font-size: 12px; color: #555; font-weight: bold; }
        .title-link { color: #333; cursor: pointer; text-decoration: none; font-weight: bold; }
        .title-link:hover { color: #3498db; text-decoration: underline; }

        .board-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
        .pagination { text-align: center; }
        .page-btn { display: inline-block; margin: 0 5px; padding: 8px 14px; border: 1px solid #ddd; cursor: pointer; border-radius: 6px; }
        .page-btn.active { background: #3498db; color: white; border-color: #3498db; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        .form-group textarea { height: 200px; resize: none; }
        
        #imagePreview { max-width: 100%; margin-top: 10px; border-radius: 5px; display: none; }
        .detail-img { max-width: 100%; margin: 20px 0; display: block; }
        
        /* 답글 영역 스타일 */
        .reply-section { margin-top: 40px; border-top: 2px solid #ddd; padding-top: 20px; }
        .reply-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .reply-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .reply-author { font-weight: bold; color: #333; }
        .reply-date { color: #888; }
        .reply-content { white-space: pre-wrap; color: #444; line-height: 1.5; font-size: 14px; }
        .reply-form-box { background: #f9f9f9; padding: 15px; border-radius: 6px; margin-top: 20px; }

        .view-section { display: none; }
        .active-section { display: block; }
        #loading { display: none; text-align: center; padding: 20px; font-weight: bold; color: #3498db; }
    </style>
</head>
<body>

<div class="header">Secret Toys</div>

<div class="container">
    <div id="loading">데이터를 처리하는 중입니다...</div>

    <div id="listView" class="view-section active-section">
        <div class="board-header">
            <div class="board-title">자유 게시판</div>
            <button class="btn write-btn" onclick="showWriteForm()">글쓰기</button>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="제목 또는 작성자로 검색..." onkeyup="if(window.event.keyCode==13){searchPosts()}">
            <button class="btn" onclick="searchPosts()">검색</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 5%;"><input type="checkbox" id="selectAllCheckbox" onclick="toggleAll(this)"></th>
                    <th style="width: 10%;">카테고리</th>
                    <th style="width: 45%;">제목</th>
                    <th style="width: 15%;">작성자</th>
                    <th style="width: 25%;">날짜</th>
                </tr>
            </thead>
            <tbody id="postTable"></tbody>
        </table>
        
        <div class="board-footer">
            <div>
                <button class="btn edit-btn" onclick="editSelected()">수정</button>
                <button class="btn delete-btn" onclick="deleteSelected()">삭제</button>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <div id="formView" class="view-section">
        <h2 id="formTitle">게시글 작성</h2>
        <input type="hidden" id="editId">
        
        <div class="form-group">
            <label>카테고리</label>
            <select id="postCategoryInput">
                <option value="인증">인증</option>
                <option value="썰">썰</option>
                <option value="구인">구인</option>
                <option value="후기">후기</option>
            </select>
        </div>
        <div class="form-group">
            <label>제목</label>
            <input type="text" id="postTitleInput">
        </div>
        <div class="form-group">
            <label>작성자</label>
            <input type="text" id="postAuthorInput">
        </div>
        <div class="form-group">
            <label>작성 일시 수정 (년-월-일 시:분:초)</label>
            <input type="datetime-local" id="postDateInput" step="1">
        </div>
        <div class="form-group">
            <label>내용</label>
            <textarea id="postContentInput"></textarea>
        </div>
        <div class="form-group">
            <label>이미지 첨부 (최대 1MB 권장)</label>
            <input type="file" id="postImageInput" accept="image/*" onchange="previewImage(this)">
            <img id="imagePreview">
        </div>
        <div style="text-align: right;">
            <button class="btn back-btn" onclick="showList()">취소</button>
            <button class="btn save-btn" onclick="savePost()">저장하기</button>
        </div>
    </div>

    <div id="detailView" class="view-section">
        <h2 id="detailTitle"></h2>
        <div style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; color: #666;">
            분류: <span id="detailCategory" class="category-badge"></span> | 
            작성자: <span id="detailAuthor"></span> | 
            날짜: <span id="detailDate"></span>
        </div>
        <div id="detailImageContainer"></div>
        <div id="detailContent" style="line-height: 1.6; min-height: 150px; white-space: pre-wrap;"></div>
        
        <div class="reply-section">
            <h3 style="font-size: 18px; margin-bottom: 15px;">답글</h3>
            <div id="replyListContainer"></div>
            
            <div class="reply-form-box">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="replyAuthorInput" placeholder="답글 작성자" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <input type="datetime-local" id="replyDateInput" step="1" style="flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <textarea id="replyContentInput" placeholder="답글 내용을 입력하세요..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; resize: none; margin-bottom: 10px; font-family: inherit;"></textarea>
                <div style="text-align: right;">
                    <button class="btn write-btn" onclick="addReply()">답글 등록</button>
                </div>
            </div>
        </div>
        <div style="margin-top: 30px; text-align: center;">
            <button class="btn back-btn" onclick="showList()">목록으로 돌아가기</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAh47SRumEK8TIuivz3o0cb61bWIGhcYTc",
        authDomain: "board-e1a7d.firebaseapp.com",
        projectId: "board-e1a7d",
        storageBucket: "board-e1a7d.firebasestorage.app",
        messagingSenderId: "699281685694",
        appId: "1:699281685694:web:1b835d499fc4e44bd432ef"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let posts = [];
    let filteredPosts = [];
    const postsPerPage = 5;
    let currentPage = 1;
    let currentPostId = null;
    let selectedImageData = "";

    // 전역 함수 연결
    window.showList = showList;
    window.showWriteForm = showWriteForm;
    window.searchPosts = searchPosts;
    window.previewImage = previewImage;
    window.savePost = savePost;
    window.viewPost = viewPost;
    window.editSelected = editSelected;
    window.deleteSelected = deleteSelected;
    window.goPage = goPage;
    window.syncRowHighlight = syncRowHighlight;
    window.toggleAll = toggleAll;
    window.addReply = addReply;

    // 현재 시간을 YYYY-MM-DDTHH:mm:ss 형식으로 가져오는 함수 (초 단위 포함)
    function getNowString() {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        const localISOTime = (new Date(now - offset)).toISOString().slice(0, 19);
        return localISOTime;
    }

    // T를 공백으로 바꿔서 깔끔하게 보여주는 함수
    function formatDateTimeDisplay(dateTimeStr) {
        if(!dateTimeStr) return "";
        return dateTimeStr.replace('T', ' ');
    }

    async function fetchPosts() {
        showLoading(true);
        posts = [];
        try {
            const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc) => {
                posts.push({ id: doc.id, ...doc.data() });
            });
            filteredPosts = [...posts];
            renderPosts();
        } catch (error) {
            console.error("데이터 불러오기 에러:", error);
        }
        showLoading(false);
    }

    async function savePost() {
        const category = document.getElementById('postCategoryInput').value;
        const title = document.getElementById('postTitleInput').value;
        const author = document.getElementById('postAuthorInput').value;
        const date = document.getElementById('postDateInput').value || getNowString();
        const content = document.getElementById('postContentInput').value;
        const editId = document.getElementById('editId').value;

        if(!title || !author || !content) {
            alert("제목, 작성자, 내용은 필수 입력 항목입니다!");
            return;
        }

        showLoading(true);
        const postData = {
            category: category,
            title: title,
            author: author,
            date: date, 
            content: content,
            image: selectedImageData,
            createdAt: editId ? undefined : new Date() 
        };

        try {
            if (editId) {
                const postRef = doc(db, "posts", editId);
                delete postData.createdAt; 
                await updateDoc(postRef, postData);
            } else {
                postData.replies = []; // 새 글 작성 시 빈 답글 배열 추가
                await addDoc(collection(db, "posts"), postData);
            }
            await fetchPosts();
            showList();
        } catch (error) {
            console.error("저장 에러:", error);
            alert("저장에 실패했습니다.");
        }
        showLoading(false);
    }

    // --- 답글(댓글) 기능 ---
    async function addReply() {
        const author = document.getElementById('replyAuthorInput').value;
        const date = document.getElementById('replyDateInput').value || getNowString();
        const content = document.getElementById('replyContentInput').value;

        if(!author || !content) {
            alert("작성자와 답글 내용을 입력해주세요!");
            return;
        }

        const newReply = {
            id: Date.now().toString(),
            author: author,
            date: date,
            content: content
        };

        const postIndex = posts.findIndex(p => p.id === currentPostId);
        if(postIndex > -1) {
            const post = posts[postIndex];
            if(!post.replies) post.replies = [];
            post.replies.push(newReply);

            showLoading(true);
            try {
                const postRef = doc(db, "posts", currentPostId);
                await updateDoc(postRef, { replies: post.replies });
                
                renderReplies(post.replies); // 화면 즉시 업데이트
                
                // 폼 초기화
                document.getElementById('replyAuthorInput').value = "";
                document.getElementById('replyContentInput').value = "";
                document.getElementById('replyDateInput').value = getNowString();
            } catch (error) {
                console.error("답글 저장 에러:", error);
                alert("답글을 등록하는 중 문제가 발생했습니다.");
            }
            showLoading(false);
        }
    }

    function renderReplies(replies) {
        const container = document.getElementById('replyListContainer');
        if(!replies || replies.length === 0) {
            container.innerHTML = "<p style='color: #888; font-size: 14px;'>아직 등록된 답글이 없습니다.</p>";
            return;
        }

        container.innerHTML = replies.map(reply => `
            <div class="reply-item">
                <div class="reply-header">
                    <span class="reply-author">${reply.author}</span>
                    <span class="reply-date">${formatDateTimeDisplay(reply.date)}</span>
                </div>
                <div class="reply-content">${reply.content}</div>
            </div>
        `).join('');
    }
    // ----------------------

    function renderPosts() {
        const table = document.getElementById("postTable");
        table.innerHTML = "";
        const start = (currentPage - 1) * postsPerPage;
        const end = start + postsPerPage;
        const pagePosts = filteredPosts.slice(start, end);

        document.getElementById('selectAllCheckbox').checked = false;

        if(pagePosts.length === 0) {
            table.innerHTML = "<tr><td colspan='5'>게시글이 없습니다.</td></tr>";
        }

        pagePosts.forEach(post => {
            const cat = post.category || '일반'; 
            table.innerHTML += `
                <tr class="post-row" id="row-${post.id}">
                    <td><input type="checkbox" class="post-checkbox" value="${post.id}" onclick="syncRowHighlight('${post.id}')"></td>
                    <td><span class="category-badge">${cat}</span></td>
                    <td style="text-align: left; padding-left: 20px;">
                        <a class="title-link" onclick="viewPost('${post.id}')">${post.title}</a>
                        ${post.replies && post.replies.length > 0 ? `<span style="color:#e74c3c; font-size:12px; margin-left:5px;">[${post.replies.length}]</span>` : ''}
                    </td>
                    <td>${post.author}</td>
                    <td>${formatDateTimeDisplay(post.date)}</td>
                </tr>
            `;
        });
        renderPagination();
    }

    function syncRowHighlight(id) {
        const checkbox = document.querySelector(`.post-checkbox[value="${id}"]`);
        const row = document.getElementById(`row-${id}`);
        if (checkbox.checked) {
            row.classList.add('selected');
        } else {
            row.classList.remove('selected');
        }
    }

    function toggleAll(source) {
        const checkboxes = document.querySelectorAll('.post-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = source.checked;
            syncRowHighlight(cb.value);
        });
    }

    function getSelectedIds() {
        const checkboxes = document.querySelectorAll('.post-checkbox:checked');
        return Array.from(checkboxes).map(cb => cb.value);
    }

    function editSelected() {
        const selectedIds = getSelectedIds();
        
        if (selectedIds.length === 0) {
            alert("수정할 게시글을 하나 선택해주세요.");
            return;
        }
        if (selectedIds.length > 1) {
            alert("수정은 한 번에 하나의 게시글만 가능합니다.");
            return;
        }

        const targetId = selectedIds[0];
        const post = posts.find(p => p.id === targetId);
        
        showWriteForm();
        document.getElementById('formTitle').innerText = "게시글 수정";
        document.getElementById('editId').value = post.id;
        document.getElementById('postCategoryInput').value = post.category || '인증';
        document.getElementById('postTitleInput').value = post.title;
        document.getElementById('postAuthorInput').value = post.author;
        document.getElementById('postDateInput').value = post.date;
        document.getElementById('postContentInput').value = post.content;
        
        if(post.image) {
            const preview = document.getElementById('imagePreview');
            preview.src = post.image;
            preview.style.display = "block";
            selectedImageData = post.image;
        }
    }

    async function deleteSelected() {
        const selectedIds = getSelectedIds();
        
        if (selectedIds.length === 0) {
            alert("삭제할 게시글을 선택해주세요.");
            return;
        }

        if(confirm(`선택한 ${selectedIds.length}개의 게시글을 정말로 삭제하시겠습니까?`)) {
            showLoading(true);
            try {
                const deletePromises = selectedIds.map(id => deleteDoc(doc(db, "posts", id)));
                await Promise.all(deletePromises);
                
                await fetchPosts();
                showList();
            } catch (error) {
                console.error("삭제 에러:", error);
                alert("삭제 중 일부 실패가 발생했습니다.");
            }
            showLoading(false);
        }
    }

    function viewPost(id) {
        const post = posts.find(p => p.id === id);
        currentPostId = id;
        document.getElementById("detailCategory").innerText = post.category || '일반';
        document.getElementById("detailTitle").innerText = post.title;
        document.getElementById("detailAuthor").innerText = post.author;
        document.getElementById("detailDate").innerText = formatDateTimeDisplay(post.date);
        document.getElementById("detailContent").innerText = post.content;
        
        const imgContainer = document.getElementById("detailImageContainer");
        imgContainer.innerHTML = post.image ? `<img src="${post.image}" class="detail-img">` : "";

        // 답글 렌더링 및 입력창 날짜 초기화
        renderReplies(post.replies || []);
        document.getElementById('replyDateInput').value = getNowString();

        hideAllSections();
        document.getElementById("detailView").classList.add('active-section');
    }

    function clearForm() {
        document.getElementById('editId').value = "";
        document.getElementById('postCategoryInput').value = "인증"; 
        document.getElementById('postTitleInput').value = "";
        document.getElementById('postAuthorInput').value = "";
        document.getElementById('postDateInput').value = getNowString(); 
        document.getElementById('postContentInput').value = "";
        document.getElementById('postImageInput').value = "";
        document.getElementById('imagePreview').style.display = "none";
        selectedImageData = "";
    }

    function showList() {
        hideAllSections();
        document.getElementById('listView').classList.add('active-section');
        searchPosts();
    }

    function showWriteForm() {
        hideAllSections();
        document.getElementById('formView').classList.add('active-section');
        document.getElementById('formTitle').innerText = "게시글 작성";
        clearForm();
    }

    function hideAllSections() {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active-section'));
    }

    function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    function renderPagination() {
        const pageCount = Math.ceil(filteredPosts.length / postsPerPage);
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";
        for (let i = 1; i <= pageCount; i++) {
            pagination.innerHTML += `
                <span class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goPage(${i})">${i}</span>
            `;
        }
    }

    function goPage(page) {
        currentPage = page;
        renderPosts();
    }

    function searchPosts() {
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        filteredPosts = posts.filter(p => 
            p.title.toLowerCase().includes(keyword) || 
            p.author.toLowerCase().includes(keyword) ||
            (p.category && p.category.includes(keyword))
        );
        currentPage = 1;
        renderPosts();
    }

    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedImageData = e.target.result;
                const preview = document.getElementById('imagePreview');
                preview.src = selectedImageData;
                preview.style.display = "block";
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    fetchPosts();
</script>

</body>
</html>